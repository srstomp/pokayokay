# yokay Hook System - Default Configuration
# Override per-project in .yokay/hooks.yaml

version: "1.0"

hooks:
  pre-session:
    enabled: true
    actions:
      - name: verify-clean
        type: shell
        command: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "âš ï¸ Working directory has uncommitted changes"
            git status --short
          else
            echo "âœ“ Working directory clean"
          fi

  pre-task:
    enabled: true
    actions:
      - name: check-blockers
        type: ohno
        operation: get_blocked_tasks
        on-result: |
          if [ -n "$RESULT" ]; then
            echo "âš ï¸ Blocked tasks: $RESULT"
          fi
      - name: suggest-skills
        type: script
        path: actions/suggest-skills.sh

  post-task:
    enabled: true
    actions:
      - name: sync
        type: script
        path: actions/sync.sh
      - name: commit
        type: script
        path: actions/commit.sh
      - name: detect-spike
        type: script
        path: actions/detect-spike.sh
      - name: capture-knowledge
        type: script
        path: actions/capture-knowledge.sh

  post-story:
    enabled: true
    actions:
      - name: test
        type: script
        path: actions/test.sh
      - name: mini-audit
        type: command
        command: "pokayokay:audit"
        args: ["--quick", "--story", "${STORY_ID}"]
      - name: audit-gate
        type: script
        path: actions/audit-gate.sh
        env:
          BOUNDARY_TYPE: story

  post-epic:
    enabled: true
    actions:
      - name: full-audit
        type: command
        command: "pokayokay:audit"
        args: ["${EPIC_ID}"]
      - name: audit-gate
        type: script
        path: actions/audit-gate.sh
        env:
          BOUNDARY_TYPE: epic

  on-error:
    enabled: true
    actions:
      - name: log-error
        type: shell
        command: |
          echo "âŒ Error in task ${TASK_ID}: ${ERROR_MESSAGE}"
          echo "Time: $(date -Iseconds)"
      - name: block-task
        type: ohno
        operation: set_blocker
        args:
          task_id: "${TASK_ID}"
          reason: "Error: ${ERROR_MESSAGE}"
      - name: recover
        type: script
        path: actions/recover.sh

  on-blocker:
    enabled: true
    actions:
      - name: notify
        type: shell
        command: |
          echo "ğŸš§ Blocker on ${TASK_ID}: ${BLOCKER_REASON}"
      - name: suggest-next
        type: ohno
        operation: get_next_task
        args:
          exclude: "${TASK_ID}"

  pre-commit:
    enabled: true
    actions:
      - name: lint
        type: script
        path: actions/lint.sh

  post-session:
    enabled: true
    actions:
      - name: final-sync
        type: script
        path: actions/sync.sh
      - name: summary
        type: shell
        command: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "SESSION COMPLETE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Tasks completed: ${SESSION_TASKS_COMPLETED:-0}"
          echo "Duration: ${SESSION_DURATION:-unknown}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # Post-command hooks - triggered after specific audit commands complete
  # These verify that expected tasks were created from audit findings
  post-command:
    enabled: true
    # Commands that always create tasks (audit commands)
    security:
      actions:
        - name: verify-tasks
          type: script
          path: actions/verify-tasks.sh
          env:
            TASK_PREFIX: "Security:"
    a11y:
      actions:
        - name: verify-tasks
          type: script
          path: actions/verify-tasks.sh
          env:
            TASK_PREFIX: "A11y:"
    # Commands that create tasks only with --audit flag
    test:
      flag: "--audit"
      actions:
        - name: verify-tasks
          type: script
          path: actions/verify-tasks.sh
          env:
            TASK_PREFIX: "Test:"
    observe:
      flag: "--audit"
      actions:
        - name: verify-tasks
          type: script
          path: actions/verify-tasks.sh
          env:
            TASK_PREFIX: "Observability:"
    arch:
      flag: "--audit"
      actions:
        - name: verify-tasks
          type: script
          path: actions/verify-tasks.sh
          env:
            TASK_PREFIX: "Arch:"

# Mode-specific overrides
modes:
  supervised:
    post-task:
      actions:
        - name: sync
          type: script
          path: actions/sync.sh
        # No auto-commit in supervised - human reviews first

  semi-auto:
    # Uses defaults

  autonomous:
    post-task:
      actions:
        - name: sync
          type: script
          path: actions/sync.sh
        - name: commit
          type: script
          path: actions/commit.sh
        - name: quick-test
          type: script
          path: actions/test.sh
          args: ["--bail", "--related"]

# Variables available in hooks
variables:
  TASK_ID: "Current task ID"
  TASK_TITLE: "Current task title"
  TASK_TYPE: "feature|bug|chore|spike|test|research"
  TASK_NOTES: "Notes from task completion"
  STORY_ID: "Current story ID"
  EPIC_ID: "Current epic ID"
  BOUNDARY_TYPE: "story|epic (set by audit-gate)"
  SESSION_MODE: "supervised|semi-auto|autonomous"
  SESSION_TASKS_COMPLETED: "Count of tasks completed this session"
  SESSION_DURATION: "Session duration"
  ERROR_MESSAGE: "Error message (for on-error)"
  BLOCKER_REASON: "Blocker reason (for on-blocker)"
  # Post-command variables
  SKILL_NAME: "Name of the command/skill that was run (for post-command)"
  SKILL_ARGS: "Arguments passed to the command (for post-command)"
  TASK_PREFIX: "Expected task title prefix for verification (for post-command)"
